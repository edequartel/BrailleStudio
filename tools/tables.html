<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Braille Tables</title>
  <style>
    @font-face {
      font-family: "Noto Sans";
      src: url("../assets/fonts/NotoSans-Regular.woff2") format("woff2");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Noto Sans";
      src: url("../assets/fonts/NotoSans-SemiBold.woff2") format("woff2");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #0e1117;
      --panel: #121826;
      --panel-2: #151c2b;
      --text: #e7edf5;
      --muted: #9aa7b6;
      --accent: #5dd6c7;
      --accent-2: #6fa4ff;
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.30);
      --radius: 14px;
      --mono: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      --sans: "Noto Sans", Arial, sans-serif;
    }
    [data-theme="light"] {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --panel-2: #fbfcfe;
      --text: #0b1220;
      --muted: #4b5a6a;
      --accent: #16a34a;
      --accent-2: #2563eb;
      --border: rgba(10,20,40,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 700px at 8% 10%, rgba(111,164,255,.18), transparent 60%),
        radial-gradient(800px 600px at 95% 15%, rgba(93,214,199,.15), transparent 55%),
        linear-gradient(180deg, #0b0f16, #0e1117 35%, #0b1018 100%);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 14px;
      align-items: center;
    }

    .title h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: .3px;
    }
    .title .sub {
      margin-top: 4px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
    }
    @media (max-width: 980px) {
      .topbar { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
    }

    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      background: color-mix(in oklab, var(--panel) 85%, black 15%);
      color: var(--text);
      font-family: var(--mono);
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, white 8%), var(--panel));
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-family: var(--sans);
      line-height: 1;
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .15s ease;
    }
    .btn:active { transform: translateY(1px); }

    main .wrap { padding-top: 12px; }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin: 16px 0 10px;
    }
    @media (max-width: 760px) {
      .stats { grid-template-columns: 1fr; }
    }

    .stat {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }
    .stat .label {
      font-size: 12px;
      color: var(--muted);
    }
    .stat .value {
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 13px;
    }

    .list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      box-shadow: var(--shadow);
      display: grid;
      gap: 8px;
    }

    .name {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .2px;
    }

    .desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      min-height: 36px;
    }

    .chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-family: var(--mono);
      background: color-mix(in oklab, var(--panel-2) 80%, transparent);
    }

    .status {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .status.ok { color: var(--accent); }
    .status.err { color: #ff7b7b; }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
      box-shadow: none;
    }

    .card.selected {
      border-color: color-mix(in oklab, var(--accent-2) 60%, var(--border));
      box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent-2) 50%, transparent), var(--shadow);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="title">
          <h1>Braille tables</h1>
          <div class="sub"></div>
        </div>
        <div class="controls">
          <input id="search" type="text" placeholder="Filter by language, filename, description..." aria-label="Search tables" />
          <button class="btn" id="refreshBtn">Refresh</button>
          <a class="btn" href="../index.html" title="Home">Home</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="stats">
        <div class="stat">
          <div class="label">Total tables</div>
          <div class="value" id="totalCount">—</div>
        </div>
        <div class="stat">
          <div class="label">Matching filter</div>
          <div class="value" id="filteredCount">—</div>
        </div>
        <div class="stat">
          <div class="label">Status</div>
          <div class="value status" id="statusText">idle</div>
        </div>
      </div>

      <div class="list" id="tableList"></div>
    </div>
  </main>

  <script>
    (function () {
      const THEME_KEY = "bs_theme";
      function getInitialTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === "light" || saved === "dark") return saved;
        return window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }
      document.documentElement.setAttribute("data-theme", getInitialTheme());
      window.addEventListener("storage", (ev) => {
        if (ev.key !== THEME_KEY) return;
        if (ev.newValue === "light" || ev.newValue === "dark") {
          document.documentElement.setAttribute("data-theme", ev.newValue);
        }
      });

      const el = (id) => document.getElementById(id);
      const search = el("search");
      const refreshBtn = el("refreshBtn");
      const totalCount = el("totalCount");
      const filteredCount = el("filteredCount");
      const statusText = el("statusText");
      const tableList = el("tableList");

      let tables = [];
      const baseUrl = "http://localhost:5000";

      function setStatus(text, state) {
        statusText.textContent = text;
        statusText.classList.remove("ok", "err");
        if (state) statusText.classList.add(state);
      }

      function chip(label) {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = label;
        return span;
      }

      function addIfValue(chips, label, value) {
        if (value === null || value === undefined || value === "") return;
        chips.appendChild(chip(`${label}: ${value}`));
      }

      function addIfArray(chips, label, arr) {
        if (!Array.isArray(arr) || arr.length === 0) return;
        chips.appendChild(chip(`${label}: ${arr.join(", ")}`));
      }

      function render() {
        const q = search.value.trim().toLowerCase();
        const filtered = tables.filter((t) => {
          if (!q) return true;
          const hay = [
            t.FileName,
            t.DisplayName,
            t.Language,
            t.Region,
            t.Grade,
            t.Description
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });

        filteredCount.textContent = String(filtered.length);
        tableList.innerHTML = "";

        filtered.forEach((t) => {
          const card = document.createElement("div");
          card.className = "card";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = t.DisplayName || t.FileName || "Unnamed table";

          const desc = document.createElement("div");
          desc.className = "desc";
          desc.textContent = t.Description || "No description";

          const chips = document.createElement("div");
          chips.className = "chips";
          addIfValue(chips, "Lang", t.Language);
          addIfValue(chips, "Region", t.Region);
          addIfValue(chips, "Grade", t.Grade);
          addIfArray(chips, "Type", t.Metadata && t.Metadata.type);
          addIfArray(chips, "Contract", t.Metadata && t.Metadata.contraction);
          addIfArray(chips, "System", t.Metadata && t.Metadata.system);
          addIfArray(chips, "Dots", t.Metadata && t.Metadata.dots);
          addIfArray(chips, "Dir", t.Metadata && t.Metadata.direction);
          addIfArray(chips, "Variant", t.Metadata && t.Metadata.variant);

          const actions = document.createElement("div");
          actions.className = "card-actions";
          const useBtn = document.createElement("button");
          useBtn.className = "btn small";
          useBtn.textContent = "Use table";
          useBtn.addEventListener("click", () => selectTable(t, card));
          actions.appendChild(useBtn);

          card.appendChild(name);
          card.appendChild(desc);
          card.appendChild(chips);
          card.appendChild(actions);
          tableList.appendChild(card);
        });
      }

      async function selectTable(table, cardEl) {
        if (!table || !table.FileName) return;
        const base = baseUrl.replace(/\/$/, "");
        setStatus(`setting ${table.FileName}...`, "");
        try {
          const resp = await fetch(base + "/brailletable", {
            method: "POST",
            headers: { "Content-Type": "text/plain; charset=utf-8" },
            body: table.FileName
          });
          const ok = resp.ok;
          setStatus(ok ? "table set" : `error ${resp.status}`, ok ? "ok" : "err");
          if (ok) {
            document.querySelectorAll(".card.selected").forEach((el) => {
              el.classList.remove("selected");
            });
            if (cardEl) cardEl.classList.add("selected");
          }
        } catch (err) {
          setStatus("error setting table", "err");
        }
      }

      async function loadTables() {
        const base = baseUrl.replace(/\/$/, "");
        setStatus("loading...", "");
        try {
          const resp = await fetch(base + "/tables");
          const data = await resp.json();
          if (!resp.ok || !data || data.ok !== true) {
            throw new Error("bad response");
          }
          tables = Array.isArray(data.tables) ? data.tables : [];
          totalCount.textContent = String(data.count ?? tables.length);
          setStatus("ok", "ok");
          render();
        } catch (err) {
          tables = [];
          totalCount.textContent = "—";
          filteredCount.textContent = "—";
          tableList.innerHTML = "";
          setStatus("error fetching tables", "err");
        }
      }

      search.addEventListener("input", render);
      refreshBtn.addEventListener("click", loadTables);

      loadTables();
    })();
  </script>
</body>
</html>
