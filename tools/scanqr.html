<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner</title>
  <style>
    :root {
      --bg:#0b0e14; --fg:#e9effa; --muted:#a9b6c8;
      --card:#121826; --line:rgba(255,255,255,.12);
      --btn:#1f2937;
    }
    body {
      margin: 16px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--fg);
    }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button, select {
      background: var(--btn);
      color: var(--fg);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 16px;
    }
    button:active { transform: scale(0.99); }
    #reader {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }
    .label { color: var(--muted); font-size: 13px; margin: 8px 0 6px; }
    #result {
      font-size: 16px;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed var(--line);
      min-height: 44px;
    }
    .hint { color: var(--muted); font-size: 13px; line-height: 1.35; }
  </style>
</head>
<body>
  <h1>QR Scanner</h1>

  <div class="card">
    <div class="row">
      <button id="startBtn">Start camera</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="copyBtn" disabled>Copy result</button>
    </div>

    <div class="label">Camera preview</div>
    <div id="reader"></div>

    <div class="label">Decoded QR text</div>
    <div id="result" aria-live="polite"></div>

    <p class="hint">
      Tip: On iPhone, this must be served via HTTPS (or localhost) to access the camera.
      If the camera permission prompt doesnâ€™t appear, check Safari settings.
    </p>
  </div>

  <!-- QR scanning library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const copyBtn  = document.getElementById("copyBtn");
    const resultEl = document.getElementById("result");

    let lastText = "";
    let qr = null;

    function setResult(text) {
      lastText = text || "";
      resultEl.textContent = lastText || "(no result yet)";
      copyBtn.disabled = !lastText;
    }

    setResult("");

    async function start() {
      try {
        if (!qr) qr = new Html5Qrcode("reader");

        // Prefer back camera when available
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          rememberLastUsedCamera: true
        };

        startBtn.disabled = true;
        stopBtn.disabled = false;

        await qr.start(
          { facingMode: "environment" },
          config,
          (decodedText) => {
            // Only update when it changes (avoids flicker)
            if (decodedText && decodedText !== lastText) {
              setResult(decodedText);
              // Optional: auto-stop after first scan
              // stop();
            }
          },
          () => { /* ignore scan errors */ }
        );
      } catch (err) {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        setResult("Camera error: " + (err?.message || err));
      }
    }

    async function stop() {
      try {
        if (qr) {
          await qr.stop();
          await qr.clear();
        }
      } catch (err) {
        // ignore stop errors
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    async function copy() {
      try {
        await navigator.clipboard.writeText(lastText);
        // Tiny feedback without annoying popups
        const old = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = old), 900);
      } catch {
        // Fallback: select text
        alert("Copy failed. You can manually select and copy the text.");
      }
    }

    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);
    copyBtn.addEventListener("click", copy);

    // Stop camera when leaving page
    window.addEventListener("pagehide", stop);
  </script>
</body>
</html>