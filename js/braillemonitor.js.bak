/*!
 * braillemonitor.js – Reusable Braille monitor + thumbkey component
 * -----------------------------------------------------------------
 * Usage in a page:
 *
 *   <div id="brailleMonitorComponent"></div>
 *
 *   BrailleMonitor.init({
 *     containerId: "brailleMonitorComponent",
 *     mapping: {
 *       leftthumb: () => document.getElementById("btnHello").click(),
 *       middleleftthumb: () => document.getElementById("btnCustom").click(),
 *       middlerightthumb: () => document.getElementById("btnRepeat").click(),
 *       rightthumb: () => document.getElementById("btnClear").click()
 *     }
 *   });
 *
 * Requirements:
 *   - Logging.js (optional but recommended)
 *   - braillebridge.js
 *   - brailleui.js
 */

(function (global) {
  "use strict";

  function log(source, msg, level) {
    if (global.Logging) {
      const fn =
        level === "error"
          ? Logging.error
          : level === "warn"
          ? Logging.warn
          : level === "debug"
          ? Logging.debug
          : Logging.info;
      fn.call(Logging, source, msg);
    } else if (console && console.log) {
      console.log("[" + source + "] " + msg);
    }
  }

  function makeId(base, suffix) {
    return base + "_" + suffix;
  }

  const BrailleMonitor = {
    /**
     * Initialise a Braille monitor component inside the given container.
     *
     * options:
     *   - containerId: id of a <div> where markup will be injected (required)
     *   - mapping: {
     *       leftthumb: () => { ... },
     *       middleleftthumb: () => { ... },
     *       middlerightthumb: () => { ... },
     *       rightthumb: () => { ... }
     *     }
     *   - showInfo: boolean (default true)
     */
    init(options) {
      const opts = Object.assign(
        {
          containerId: null,
          mapping: {},
          showInfo: true
        },
        options || {}
      );

      if (!opts.containerId) {
        log("BrailleMonitor", "containerId is required", "error");
        return null;
      }

      const container = document.getElementById(opts.containerId);
      if (!container) {
        log(
          "BrailleMonitor",
          "No element with id '" + opts.containerId + "'",
          "error"
        );
        return null;
      }

      const baseId = opts.containerId;
      const monitorId = makeId(baseId, "monitor");
      const thumbRowId = makeId(baseId, "thumbRow");

      // -------------------------------------------------------------------
      // Build DOM
      // -------------------------------------------------------------------
      const wrapper = document.createElement("div");
      wrapper.className = "braille-monitor-component";

      const monitorP = document.createElement("p");
      monitorP.id = monitorId;
      monitorP.className = "mono-box";
      monitorP.textContent = "(leeg)";

      const thumbRow = document.createElement("div");
      thumbRow.id = thumbRowId;
      thumbRow.className = "button-row thumb-row";

      const thumbDefs = [
        { key: "leftthumb", label: "⟵ Left" },
        { key: "middleleftthumb", label: "⟵ Mid-Left" },
        { key: "middlerightthumb", label: "Mid-Right ⟶" },
        { key: "rightthumb", label: "Right ⟶" }
      ];

      thumbDefs.forEach((def) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "thumb-key";
        btn.dataset.thumb = def.key;
        btn.textContent = def.label;
        thumbRow.appendChild(btn);
      });

      wrapper.appendChild(monitorP);
      wrapper.appendChild(thumbRow);

      if (opts.showInfo) {
        const info = document.createElement("p");
        info.className = "small";
        info.textContent =
          "Deze monitor toont 1-op-1 de tekst op de brailleleesregel. " +
          "De knoppen bootsen de duimtoetsen na en lichten op bij echte duimtoetsen.";
        wrapper.appendChild(info);
      }

      // Insert into container
      container.innerHTML = "";
      container.appendChild(wrapper);

      // -------------------------------------------------------------------
      // Attach BrailleUI monitor
      // -------------------------------------------------------------------
      if (global.BrailleUI && typeof BrailleUI.attachMonitor === "function") {
        BrailleUI.attachMonitor(monitorId);
        log(
          "BrailleMonitor",
          "BrailleUI monitor attached to #" + monitorId,
          "debug"
        );
      } else {
        log(
          "BrailleMonitor",
          "BrailleUI not available; cannot attach monitor",
          "warn"
        );
      }

      // -------------------------------------------------------------------
      // Thumbkey helpers
      // -------------------------------------------------------------------
      function invokeThumbAction(nameLower) {
        const fn = opts.mapping[nameLower];
        if (typeof fn === "function") {
          try {
            fn();
          } catch (err) {
            log(
              "BrailleMonitor",
              "Error in thumb mapping for " +
                nameLower +
                ": " +
                (err && err.message),
              "error"
            );
          }
        } else {
          log(
            "BrailleMonitor",
            "No mapping for thumbkey: " + nameLower,
            "debug"
          );
        }
      }

      function flashThumbButton(nameLower) {
        const selector =
          "#" +
          thumbRowId +
          ' .thumb-key[data-thumb="' +
          nameLower.toLowerCase() +
          '"]';
        const btn = document.querySelector(selector);
        if (!btn) return;
        btn.classList.add("active");
        setTimeout(() => btn.classList.remove("active"), 150);
      }

      // Click on simulator buttons
      const buttons = thumbRow.querySelectorAll(".thumb-key");
      buttons.forEach((btn) => {
        const nameLower = (btn.dataset.thumb || "").toLowerCase();
        btn.addEventListener("click", () => {
          invokeThumbAction(nameLower);
          flashThumbButton(nameLower);
        });
      });

      // Listen to real thumbkeys from BrailleBridge
      if (global.BrailleBridge && typeof BrailleBridge.on === "function") {
        BrailleBridge.on("thumbkey", (evt) => {
          const nameLower = (evt.nameLower || "").toLowerCase();
          log("BrailleBridge", "Thumbkey event: " + nameLower, "info");
          flashThumbButton(nameLower);
          invokeThumbAction(nameLower);
        });
      } else {
        log(
          "BrailleMonitor",
          "BrailleBridge not available; cannot listen to thumbkeys",
          "warn"
        );
      }

      return {
        monitorId,
        thumbRowId,
        containerId: baseId
      };
    }
  };

  global.BrailleMonitor = BrailleMonitor;
})(window);
