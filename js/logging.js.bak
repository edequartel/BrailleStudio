/*!
 * logging.js – Simple logging framework for BrailleServer
 * -------------------------------------------------------
 * Usage:
 *   // Configure once per page:
 *   Logging.setLevel("debug"); // or "info", "warn", "error", "none"
 *   Logging.addSink(Logging.createDomSink("logBox"));
 *
 *   // Use anywhere:
 *   Logging.info("BrailleUI-Demo", "Page loaded");
 *   Logging.debug("BrailleBridge", "Connecting...");
 *   Logging.error("Sounds", "Failed to load sounds.json");
 *
 * Existing BrailleLog shim:
 *   BrailleLog.log(source, message) → Logging.info(source, message)
 */

(function (global) {
  "use strict";

  const LEVELS = {
    debug: 10,
    info:  20,
    warn:  30,
    error: 40,
    none:  100
  };

  const LEVEL_NAMES = Object.keys(LEVELS);

  function clampLevelName(name) {
    if (!name) return "info";
    const lower = String(name).toLowerCase();
    return LEVEL_NAMES.includes(lower) ? lower : "info";
  }

  const Logging = {
    _levelName: "info",
    _levelValue: LEVELS.info,
    _sinks: new Set(),

    LEVELS,

    setLevel(name) {
      const lvl = clampLevelName(name);
      this._levelName = lvl;
      this._levelValue = LEVELS[lvl];
    },

    getLevel() {
      return this._levelName;
    },

    /**
     * Add a sink:
     *   sink(entry) where entry = { timestamp, level, source, message }
     */
    addSink(fn) {
      if (typeof fn !== "function") return;
      this._sinks.add(fn);
      return () => this._sinks.delete(fn);
    },

    clearSinks() {
      this._sinks.clear();
    },

    /**
     * Core log function
     */
    log(levelName, source, message) {
      const lvl = clampLevelName(levelName);
      const lvlValue = LEVELS[lvl];

      if (lvlValue < this._levelValue) {
        // filtered out
        return;
      }

      const entry = {
        timestamp: new Date(),
        level: lvl,
        source: source || "App",
        message: message != null ? String(message) : ""
      };

      // Dispatch to all sinks
      for (const sink of this._sinks) {
        try {
          sink(entry);
        } catch (err) {
          // last resort
          if (typeof console !== "undefined" && console.error) {
            console.error("[Logging] sink error:", err);
          }
        }
      }
    },

    debug(source, message) {
      this.log("debug", source, message);
    },

    info(source, message) {
      this.log("info", source, message);
    },

    warn(source, message) {
      this.log("warn", source, message);
    },

    error(source, message) {
      this.log("error", source, message);
    },

    /**
     * Create a sink that writes to a <pre> or other text element.
     * elementOrId: DOM element or its id.
     */
    createDomSink(elementOrId) {
      let el = null;

      function resolveElement() {
        if (el) return el;
        if (typeof elementOrId === "string") {
          el = document.getElementById(elementOrId);
        } else {
          el = elementOrId;
        }
        return el;
      }

      return function (entry) {
        const target = resolveElement();
        if (!target) return;

        const t = entry.timestamp.toISOString().substring(11, 19);
        const line = `[${t}] [${entry.level.toUpperCase()}] [${entry.source}] ${entry.message}\n`;

        target.textContent += line;
        if (typeof target.scrollTop === "number") {
          target.scrollTop = target.scrollHeight;
        }
      };
    },

    /**
     * Default console sink.
     */
    createConsoleSink() {
      return function (entry) {
        if (typeof console === "undefined") return;
        const t = entry.timestamp.toISOString().substring(11, 19);
        const prefix =
          `[${t}] [${entry.level.toUpperCase()}] [${entry.source}]`;

        if (entry.level === "error" && console.error) {
          console.error(prefix, entry.message);
        } else if (entry.level === "warn" && console.warn) {
          console.warn(prefix, entry.message);
        } else if (console.log) {
          console.log(prefix, entry.message);
        }
      };
    }
  };

  // Default: console sink at "info" level
  Logging.addSink(Logging.createConsoleSink());
  Logging.setLevel("info");

  // Expose globally
  global.Logging = Logging;

  // Backwards-compatible BrailleLog shim:
  global.BrailleLog = {
    log(source, message) {
      Logging.info(source, message);
    }
  };

})(window);
