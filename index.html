<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrailleServer ‚Äì Start</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* -------------------------------------------------------
       Fancy layout layer (keeps your existing style.css intact)
    ------------------------------------------------------- */
    :root{
      --card-bg: rgba(255,255,255,0.92);
      --card-border: rgba(15,23,42,0.10);
      --shadow: 0 14px 34px rgba(15, 23, 42, 0.12);
      --shadow2: 0 8px 18px rgba(15, 23, 42, 0.10);
      --radius: 18px;
    }

    body{
      background: linear-gradient(135deg, #eef2ff, #fff1f2, #f1f5f9);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .brand h1{
      margin:0;
      font-size:1.8rem;
      letter-spacing:-0.02em;
    }

    .brand .subtitle{
      margin:0;
      color:#475569;
      font-size:0.98rem;
    }

    .pillbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(2,6,23,0.06);
      border:1px solid rgba(2,6,23,0.10);
      font-size:0.92rem;
      color:#0f172a;
      user-select:none;
    }

    .pill code{ font-size:0.9em; }

    .hero{
      margin-top:10px;
      padding:18px 18px 16px 18px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(2,6,23,0.92), rgba(30,41,59,0.92));
      color:#e2e8f0;
      border: 1px solid rgba(148,163,184,0.20);
      box-shadow: var(--shadow);
    }

    .hero-grid{
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:16px;
      align-items:start;
    }

    @media (max-width: 900px){
      .hero-grid{ grid-template-columns: 1fr; }
    }

    .hero h2{
      margin:0 0 8px 0;
      font-size:1.25rem;
      color:#f8fafc;
    }

    .hero p{
      margin:0 0 10px 0;
      color:#cbd5e1;
      line-height:1.4;
    }

    .hero .quick{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    .hero a.cta{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.22);
      color:#f8fafc;
      text-decoration:none;
    }

    .hero a.cta:hover{
      background: rgba(255,255,255,0.18);
    }

    .panel{
      margin-top:16px;
      border-radius: var(--radius);
      background: var(--card-bg);
      border:1px solid var(--card-border);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    .panel-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(15,23,42,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(6px);
    }

    .panel-header h2{
      margin:0;
      font-size:1.1rem;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .filters input[type="search"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.15);
      min-width: 260px;
      outline:none;
    }

    .filters select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.15);
      outline:none;
      background:#fff;
    }

    .grid{
      padding:16px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
    }

    @media (max-width: 1000px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 680px){
      .grid{ grid-template-columns: 1fr; }
      .filters input[type="search"]{ min-width: 100%; }
    }

    .card{
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(255,255,255,0.92);
      padding:14px 14px 12px 14px;
      box-shadow: 0 8px 16px rgba(15,23,42,0.06);
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .card-title{
      margin:0;
      font-size:1.05rem;
      line-height:1.2;
      color:#0f172a;
    }

    .card-meta{
      margin:0;
      color:#475569;
      font-size:0.92rem;
      line-height:1.3;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:0.82rem;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(2,6,23,0.04);
      color:#0f172a;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .tag{
      font-size:0.80rem;
      padding:5px 9px;
      border-radius:999px;
      background: rgba(99,102,241,0.10);
      border:1px solid rgba(99,102,241,0.18);
      color:#1e293b;
    }

    .card-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }

    .card-actions a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      color:#0f172a;
      font-weight:600;
    }

    .card-actions a:hover{
      background: rgba(2,6,23,0.04);
    }

    .empty{
      padding:18px 16px;
      color:#475569;
    }

    .footer-note{
      margin-top:14px;
      color:#475569;
      font-size:0.92rem;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:0.9em;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid rgba(15,23,42,0.15);
      background: rgba(255,255,255,0.7);
      color:#0f172a;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>BrailleServer</h1>
        <p class="subtitle">Startpagina voor alle demo‚Äôs, spellen en tools in <code>/pages</code>.</p>
      </div>

      <div class="pillbar" aria-label="Systeemstatus">
        <div class="pill" id="pillHost">Host: <code id="hostValue">‚Äî</code></div>
        <div class="pill" id="pillMode">Index: <code id="modeValue">‚Äî</code></div>
      </div>
    </div>

    <div class="hero" role="region" aria-label="Introductie">
      <div class="hero-grid">
        <div>
          <h2>Alles op √©√©n plek</h2>
          <p>
            Deze index leest automatisch alle HTML-pagina‚Äôs uit <code>/pages</code> en toont ze als kaarten.
            Nieuwe pagina toegevoegd? Dan verschijnt die vanzelf.
          </p>
          <div class="quick">
            <a class="cta" href="pages/style-demo.html">Open style demo</a>
            <a class="cta" href="pages/" onclick="return false" aria-disabled="true" title="Directory listing is afhankelijk van hosting">
              Tip: voeg nieuwe pagina‚Äôs toe in <code>/pages</code>
            </a>
          </div>

          <p class="footer-note">
            Navigatie: gebruik <span class="kbd">Tab</span> om door kaarten te lopen en <span class="kbd">Enter</span> om te openen.
          </p>
        </div>

        <div>
          <!-- Optional: you already have these ids/classes in style.css; if not, it's still fine -->
          <div id="connectionStatus" class="status">üîå BrailleBridge: <strong id="bridgeState">Onbekend</strong></div>
          <div id="currentLineBox" class="status" style="margin-top: 12px;">CURRENT LINE: <span id="demoLine">‚†É‚†ó‚†Å‚†ä‚†á‚†á‚†ë ‚†é‚†ë‚†ó‚†ß‚†ë‚†ó</span></div>
          <div id="lastChoice" class="status" style="margin-top: 12px;">‚úÖ Laatste event: <strong id="lastEvent">‚Äî</strong></div>
        </div>
      </div>
    </div>

    <div class="panel" role="region" aria-label="Pagina-overzicht">
      <div class="panel-header">
        <h2>Pagina‚Äôs in <code>/pages</code></h2>

        <div class="filters">
          <input id="searchBox" type="search" placeholder="Zoek op titel, bestand, tag‚Ä¶" aria-label="Zoeken" />
          <select id="tagFilter" aria-label="Filter op tag">
            <option value="">Alle tags</option>
          </select>
        </div>
      </div>

      <div id="cards" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" style="display:none;"></div>
    </div>

    <div class="footer-note">
      Bron voor index: eerst <code>pages/pages.json</code> (als die bestaat), anders GitHub Contents API.
      Voor lokaal gebruik: voeg bij voorkeur <code>pages/pages.json</code> toe.
    </div>
  </div>

  <script>
    // -------------------------------------------------------
    // BrailleBridge "friendly probe" (non-breaking)
    // -------------------------------------------------------
    (function initBridgeProbe(){
      const bridgeState = document.getElementById("bridgeState");
      const lastEvent = document.getElementById("lastEvent");

      // We only check reachability; do not fail if BrailleBridge JS isn't loaded on this page.
      const baseUrl = "http://localhost:5000";
      const timeoutMs = 800;

      function withTimeout(promise, ms){
        return Promise.race([
          promise,
          new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), ms))
        ]);
      }

      async function ping(){
        try{
          // Very lightweight: try /hello if exists, else just fetch base (some servers 404 and that's ok).
          const res = await withTimeout(fetch(baseUrl + "/hello", { method:"GET" }), timeoutMs);
          bridgeState.textContent = (res.ok ? "Beschikbaar" : "Onbekend (geen /hello)");
        }catch(e){
          bridgeState.textContent = "Niet bereikbaar";
        }
      }

      // Update last event if another page stores it in localStorage
      try{
        const saved = localStorage.getItem("brailleserver:lastEvent");
        if(saved) lastEvent.textContent = saved;
      }catch(_){}

      ping();
    })();

    // -------------------------------------------------------
    // Pages index loader
    // -------------------------------------------------------
    const owner = "edequartel";
    const repo  = "BrailleServer";
    const pagesDir = "pages";

    const hostValue = document.getElementById("hostValue");
    const modeValue = document.getElementById("modeValue");

    const cardsEl = document.getElementById("cards");
    const emptyEl = document.getElementById("empty");
    const searchBox = document.getElementById("searchBox");
    const tagFilter = document.getElementById("tagFilter");

    hostValue.textContent = location.host || "local file";
    modeValue.textContent = "‚Ä¶";

    function titleFromFilename(name){
      // "game-words.html" -> "Game Words"
      return name
        .replace(/\.html$/i, "")
        .replace(/[-_]+/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function guessTags(name){
      const n = name.toLowerCase();
      const tags = [];
      if(n.includes("demo")) tags.push("demo");
      if(n.includes("game")) tags.push("game");
      if(n.includes("braille")) tags.push("braille");
      if(n.includes("sound")) tags.push("audio");
      if(n.includes("ui")) tags.push("ui");
      return tags;
    }

    function normalizeItem(item){
      // item: { file, title?, description?, tags?, badge?, order? }
      const file = item.file;
      const title = item.title || titleFromFilename(file);
      const description = item.description || "Geen beschrijving (voeg toe in pages/pages.json).";
      const tags = Array.isArray(item.tags) ? item.tags : guessTags(file);
      const badge = item.badge || (file.toLowerCase().includes("demo") ? "Demo" : "Page");
      const order = Number.isFinite(item.order) ? item.order : 9999;
      return { file, title, description, tags, badge, order };
    }

    async function tryLoadManifest(){
      // Preferred for local hosting & custom metadata
      try{
        const res = await fetch(`${pagesDir}/pages.json`, { cache: "no-store" });
        if(!res.ok) return null;
        const json = await res.json();
        if(!Array.isArray(json)) return null;
        modeValue.textContent = "pages/pages.json";
        return json.map(normalizeItem);
      }catch(_){
        return null;
      }
    }

    async function loadViaGitHubApi(){
      // Fallback mainly for GitHub Pages where directory listing does not exist.
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${pagesDir}`;
      const res = await fetch(apiUrl, { headers: { "Accept": "application/vnd.github+json" } });
      if(!res.ok) throw new Error("GitHub API failed: " + res.status);

      const data = await res.json();
      const htmlFiles = (Array.isArray(data) ? data : [])
        .filter(x => x && x.type === "file" && /\.html$/i.test(x.name))
        .map(x => normalizeItem({ file: x.name }));

      modeValue.textContent = "GitHub Contents API";
      return htmlFiles;
    }

    function uniqueSortedTags(items){
      const set = new Set();
      items.forEach(i => (i.tags || []).forEach(t => set.add(String(t))));
      return Array.from(set).sort((a,b) => a.localeCompare(b));
    }

    function renderTagFilter(items){
      const tags = uniqueSortedTags(items);
      // reset
      while(tagFilter.options.length > 1) tagFilter.remove(1);
      tags.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        tagFilter.appendChild(opt);
      });
    }

    function render(items){
      const q = (searchBox.value || "").trim().toLowerCase();
      const tag = (tagFilter.value || "").trim().toLowerCase();

      const filtered = items.filter(i => {
        const hay = `${i.title} ${i.file} ${i.description} ${(i.tags||[]).join(" ")}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okT = !tag || (i.tags || []).map(x => String(x).toLowerCase()).includes(tag);
        return okQ && okT;
      });

      cardsEl.innerHTML = "";
      emptyEl.style.display = filtered.length ? "none" : "block";

      if(!filtered.length){
        emptyEl.textContent = "Geen resultaten. Pas je zoekterm of tagfilter aan.";
        return;
      }

      filtered
        .sort((a,b) => (a.order - b.order) || a.title.localeCompare(b.title))
        .forEach(i => {
          const card = document.createElement("div");
          card.className = "card";

          const top = document.createElement("div");
          top.className = "card-top";

          const left = document.createElement("div");
          const h = document.createElement("h3");
          h.className = "card-title";
          h.textContent = i.title;

          const p = document.createElement("p");
          p.className = "card-meta";
          p.textContent = i.description;

          left.appendChild(h);
          left.appendChild(p);

          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = i.badge;

          top.appendChild(left);
          top.appendChild(badge);

          const tags = document.createElement("div");
          tags.className = "tags";
          (i.tags || []).slice(0, 6).forEach(t => {
            const s = document.createElement("span");
            s.className = "tag";
            s.textContent = t;
            tags.appendChild(s);
          });

          const actions = document.createElement("div");
          actions.className = "card-actions";

          const open = document.createElement("a");
          open.href = `${pagesDir}/${i.file}`;
          open.textContent = "Open";
          open.setAttribute("aria-label", `Open ${i.title}`);

          const copy = document.createElement("a");
          copy.href = "#";
          copy.textContent = "Copy link";
          copy.addEventListener("click", async (e) => {
            e.preventDefault();
            const url = new URL(open.getAttribute("href"), location.href).toString();
            try{
              await navigator.clipboard.writeText(url);
              copy.textContent = "Copied";
              setTimeout(() => copy.textContent = "Copy link", 900);
            }catch(_){
              prompt("Kopieer deze link:", url);
            }
          });

          actions.appendChild(open);
          actions.appendChild(copy);

          card.appendChild(top);
          card.appendChild(tags);
          card.appendChild(actions);

          cardsEl.appendChild(card);
        });
    }

    (async function main(){
      let items = await tryLoadManifest();

      if(!items){
        // Only try GitHub API on "real" web hosting (not file://)
        const canUseNetwork = location.protocol.startsWith("http");
        if(canUseNetwork){
          try{
            items = await loadViaGitHubApi();
          }catch(e){
            modeValue.textContent = "fallback";
            items = [];
          }
        }else{
          modeValue.textContent = "file:// (geen API)";
          items = [];
        }
      }

      renderTagFilter(items);
      render(items);

      searchBox.addEventListener("input", () => render(items));
      tagFilter.addEventListener("change", () => render(items));
    })();
  </script>
</body>
</html>