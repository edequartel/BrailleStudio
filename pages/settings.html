<!-- /settings.html -->
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --text:#e8eaf0;
      --muted:#aab0c0;
      --border:#2a2f3a;
      --btn:#1b2030;
      --btn2:#232a3d;
      --focus:#8aa4ff;
      --radius:12px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel:#ffffff;
        --text:#111827;
        --muted:#6b7280;
        --border:#e5e7eb;
        --btn:#eef2ff;
        --btn2:#e5e7ff;
        --focus:#3056ff;
      }
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header{
      position:sticky;
      top:0;
      background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .wrap{
      max-width: 880px;
      margin: 0 auto;
      padding: 16px;
    }
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
    }
    h1{
      font-size: 18px;
      margin:0;
      letter-spacing: .2px;
    }
    .actions{ display:flex; gap:10px; align-items:center; }
    button, a.btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover, a.btn:hover{ background:var(--btn2); }
    button:focus-visible, select:focus-visible, input:focus-visible, a.btn:focus-visible{
      outline: 3px solid color-mix(in srgb, var(--focus) 55%, transparent);
      outline-offset: 2px;
    }
    main .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
    }
    .row{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:14px;
      align-items:start;
      padding:12px 0;
      border-top:1px solid var(--border);
    }
    .row:first-child{ border-top:none; padding-top:0; }
    .label{
      font-weight:700;
      letter-spacing:.2px;
    }
    .hint{
      color:var(--muted);
      margin-top:6px;
      font-size: 13px;
    }
    select, input[type="text"]{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      font-size: 15px;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top:10px;
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size: 12px;
      margin-left:8px;
      vertical-align:middle;
    }
    .toast{
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background: color-mix(in srgb, var(--panel) 60%, transparent);
      display:none;
    }
    .toast.show{ display:block; }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="bar">
      <h1>Settings</h1>
      <div class="actions">
        <a class="btn" id="backBtn" href="./words.html" aria-label="Back to words">Back</a>
        <button id="saveBtn" type="button">Save</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card" role="region" aria-label="General settings">
      <div class="row">
        <div>
          <div class="label">Language <span class="pill">key: <code>bs_lang</code></span></div>
          <div class="hint">Used by runner.js and BrailleMonitor.</div>
        </div>
        <div>
          <select id="langSelect" aria-label="Language">
            <option value="nl">Nederlands (nl)</option>
            <option value="en">English (en)</option>
          </select>
          <div class="small">Saved locally in your browser. No server required.</div>
        </div>
      </div>

      <!-- Optional: you can extend settings later -->
      <div class="row">
        <div>
          <div class="label">Debug</div>
          <div class="hint">Shows what is currently stored.</div>
        </div>
        <div>
          <div id="debugInfo" class="small"></div>
        </div>
      </div>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>
  </div>
</main>

<script>
(function () {
  "use strict";

  const LANG_KEY = "bs_lang";

  function log(msg, data) {
    const line = data ? `${msg} ${safeJson(data)}` : msg;
    if (typeof window.logMessage === "function") window.logMessage(line);
    else console.log(line);
  }
  function safeJson(x) {
    try { return JSON.stringify(x); } catch { return String(x); }
  }

  function normalizeLang(tag) {
    const t = String(tag || "").trim().toLowerCase();
    const base = t.split("-")[0];
    return (base === "nl" || base === "en") ? base : "nl";
  }

  function safeGet(key) {
    try { return localStorage.getItem(key); }
    catch (e) { log("[settings] localStorage.getItem failed", { key, error: String(e) }); return null; }
  }

  function safeSet(key, value) {
    try { localStorage.setItem(key, value); return true; }
    catch (e) { log("[settings] localStorage.setItem failed", { key, value, error: String(e) }); return false; }
  }

  const langSelect = document.getElementById("langSelect");
  const saveBtn = document.getElementById("saveBtn");
  const toast = document.getElementById("toast");
  const debugInfo = document.getElementById("debugInfo");

  function showToast(text) {
    toast.textContent = text;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1800);
  }

  function refreshDebug() {
    const stored = safeGet(LANG_KEY);
    const htmlLang = document.documentElement.getAttribute("lang");
    const nav = (navigator.languages && navigator.languages[0]) ? navigator.languages[0] : navigator.language;

    debugInfo.innerHTML =
      `<div>localStorage <code>${LANG_KEY}</code>: <code>${stored ?? "null"}</code></div>` +
      `<div>html lang: <code>${htmlLang ?? "null"}</code></div>` +
      `<div>navigator language: <code>${nav ?? "null"}</code></div>`;
  }

  function loadUi() {
    const stored = safeGet(LANG_KEY);
    const lang = normalizeLang(stored || document.documentElement.getAttribute("lang") || ((navigator.languages && navigator.languages[0]) ? navigator.languages[0] : navigator.language));
    document.documentElement.setAttribute("lang", lang);
    langSelect.value = lang;
    refreshDebug();
    log("[settings] loaded", { stored, lang });
  }

  function saveLang(lang) {
    const n = normalizeLang(lang);
    const ok = safeSet(LANG_KEY, n);
    document.documentElement.setAttribute("lang", n);
    refreshDebug();
    log("[settings] saved", { key: LANG_KEY, lang: n, ok });

    if (ok) showToast(`Saved: ${n}`);
    else showToast("Could not save (storage blocked).");

    // If Settings is opened in same tab, runner won't get a "storage" event.
    // Navigating back will trigger runner's pageshow handler (your runner already does this).
  }

  langSelect.addEventListener("change", () => saveLang(langSelect.value));
  saveBtn.addEventListener("click", () => saveLang(langSelect.value));

  // iOS BFCache safe: when coming back to this page
  window.addEventListener("pageshow", loadUi);

  loadUi();
})();
</script>
</body>
</html>