<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --text:#e8eaf0;
      --muted:#aab0c0;
      --border:#2a2f3a;
      --focus:#8aa4ff;
      --radius:12px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:880px; margin:0 auto; padding:16px; }
    header{ border-bottom:1px solid var(--border); }
    h1{ font-size:18px; margin:0; }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
    }
    .row{
      display:grid;
      grid-template-columns:220px 1fr;
      gap:14px;
      padding:12px 0;
      border-top:1px solid var(--border);
    }
    .row:first-child{ border-top:none; }
    .label{ font-weight:700; }
    .hint{ color:var(--muted); font-size:13px; margin-top:6px; }
    select{ width:100%; padding:10px; }
    .toggle{ display:flex; align-items:center; gap:10px; }
    .debug{
      margin-top:16px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      color:#aab0c0;
    }
  </style>

  <!-- Fail-safe debug (always runs) -->
  <script>
  (function(){
    function set(msg){
      try{
        var el = document.getElementById("debugBox");
        if (el) el.textContent = msg;
      }catch{}
    }
    window.__debug = function(label, obj){
      set(label + "\n" + (obj ? JSON.stringify(obj, null, 2) : ""));
      console.log(label, obj || "");
    };
    document.addEventListener("DOMContentLoaded", function(){
      set(
        "Debug: DOMContentLoaded\n" +
        "URL: " + location.href + "\n" +
        "Protocol: " + location.protocol
      );
    });
    window.addEventListener("error", function(e){
      set("Debug: WINDOW ERROR\n" + e.message + "\n" + (e.filename||"") + ":" + (e.lineno||""));
    });
    window.addEventListener("unhandledrejection", function(e){
      set("Debug: UNHANDLED REJECTION\n" + String(e.reason));
    });
  })();
  </script>

  <!-- IMPORTANT: page is /pages/settings.html so we must go up one level -->
  <script src="../js/settings-store.js"></script>
  <script src="../js/i18n.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <h1 data-i18n="settings.title">Settings</h1>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">

      <div class="row">
        <div>
          <div class="label" data-i18n="settings.language.label">Language</div>
          <div class="hint" data-i18n="settings.language.hint">Used by runner.</div>
        </div>
        <div>
          <select id="langSelect">
            <option value="nl" data-i18n="settings.language.option.nl">Nederlands</option>
            <option value="en" data-i18n="settings.language.option.en">English</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label" data-i18n="settings.sim.label">SSOC Simulator</div>
          <div class="hint" data-i18n="settings.sim.hint">Local fallback mode</div>
        </div>
        <div class="toggle">
          <input type="checkbox" id="simToggle">
          <label for="simToggle" data-i18n="settings.sim.toggle">Use simulator</label>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label" data-i18n="settings.method.label">Method</div>
          <div class="hint" data-i18n="settings.method.hint">Select the active teaching method.</div>
        </div>
        <div>
          <select id="methodSelect">
            <option value="mpop.json" data-i18n="settings.method.option.mpop">MPOP</option>
            <option value="marechal.json" data-i18n="settings.method.option.marechal">Maréchal</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label" data-i18n="settings.braillemode.label">Braille mode</div>
          <div class="hint" data-i18n="settings.braillemode.hint">Choose between 6-dot and 8-dot.</div>
        </div>
        <div>
          <select id="brailleModeSelect">
            <option value="literacy" data-i18n="settings.braillemode.option.literacy">Literacy (6 dots)</option>
            <option value="computer" data-i18n="settings.braillemode.option.computer">Computer (8 dots)</option>
          </select>
        </div>
      </div>

      <div id="debugBox" class="debug">Debug: (loading…)</div>
    </div>
  </div>
</main>

<script>
(async function(){
  "use strict";

  const debug = window.__debug || function(){};

  debug("[settings] script start", {
    hasSettingsStore: !!window.SettingsStore,
    hasI18n: !!window.I18n
  });

  if (!window.SettingsStore) {
    debug("ERROR: SettingsStore missing (check ../js/settings-store.js path)");
    return;
  }
  if (!window.I18n) {
    debug("ERROR: I18n missing (check ../js/i18n.js path)");
    return;
  }

  // IMPORTANT: from /pages/settings.html, basePath to root is "../"
  const BASE_PATH = "../";

  const elLang        = document.getElementById("langSelect");
  const elSim         = document.getElementById("simToggle");
  const elMethod      = document.getElementById("methodSelect");
  const elBrailleMode = document.getElementById("brailleModeSelect");

  function forceSelectRepaint(sel){
    const idx = sel.selectedIndex;
    sel.selectedIndex = -1;
    sel.selectedIndex = idx;
  }

  async function applyLang(lang) {
    const res = await I18n.loadAndApply({ lang, basePath: BASE_PATH });

    // repaint selected option labels if browser caches them visually
    forceSelectRepaint(elLang);
    forceSelectRepaint(elMethod);
    forceSelectRepaint(elBrailleMode);

    debug("[settings] i18n applied", {
      lang: res.lang,
      applied: res.applied,
      i18nUrlExample: `${BASE_PATH}i18n/${res.lang}.json`
    });
  }

  async function syncUI() {
    const state = SettingsStore.load();

    elLang.value = state.lang;
    elSim.checked = !!state.ssocSimulator;
    elMethod.value = state.method;
    elBrailleMode.value = state.brailleMode || "literacy";

    await applyLang(state.lang);

    debug("[settings] synced", state);
  }

  async function update(patch) {
    const state = SettingsStore.patch(patch);
    if (Object.prototype.hasOwnProperty.call(patch, "lang")) {
      await applyLang(state.lang);
    }
    debug("[settings] updated", { patch, state });
  }

  elLang.addEventListener("change", () => update({ lang: I18n.normalizeLang(elLang.value) }));
  elSim.addEventListener("change", () => update({ ssocSimulator: elSim.checked }));
  elMethod.addEventListener("change", () => update({ method: elMethod.value }));
  elBrailleMode.addEventListener("change", () => update({ brailleMode: elBrailleMode.value }));

  window.addEventListener("pageshow", syncUI);
  syncUI();
})();
</script>
</body>
</html>