<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>BrailleUI Demo – BrailleServer</title>

  <!-- Shared styling from your repo -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Optional: Howler, only if you want sounds hier -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Logging framework (NEW) -->
  <script src="../js/logging.js"></script>

  <!-- Frameworks from BrailleServer -->
  <script src="../js/braillebridge.js"></script>
  <script src="../js/brailleui.js"></script>
  <script src="../js/sounds.js"></script>
</head>
<body>
  <main class="container">
    <h1>BrailleUI Demo</h1>

    <section class="card">
      <h2>Verbinding</h2>
      <p>Status: <span id="connectionStatus">disconnected</span></p>
    </section>

    <section class="card">
      <h2>Braille-monitor (1:1 met leesregel)</h2>
      <p id="brailleMonitor" class="mono-box">(leeg)</p>
    </section>

    <section class="card">
      <h2>Regel sturen</h2>
      <button id="btnHello">Stuur “Hallo braille!”</button><br /><br />

      <label for="customText">Eigen tekst:</label><br />
      <input id="customText" type="text"
             placeholder="Typ hier je tekst"
             style="width: 100%; max-width: 420px; margin-top: 4px;" /><br /><br />

      <button id="btnCustom">Stuur eigen tekst</button>
      <button id="btnRepeat">Herhaal huidige regel</button>
      <button id="btnClear">Maak leeg</button>
    </section>

    <section class="card">
      <h2>Laatste cursorinformatie</h2>
      <p id="lastCursor">Nog niets…</p>
    </section>

    <section class="card">
      <h2>Logging</h2>
      <div id="logBox" class="log-box"></div>
    </section>
  </main>

  <script>
    function setConnectionStatus(text, ok) {
      const el = document.getElementById("connectionStatus");
      if (!el) return;
      el.textContent = text;
      el.style.color = ok ? "green" : "red";
    }

    function setLastCursor(text) {
      const el = document.getElementById("lastCursor");
      if (el) el.textContent = text;
    }

    // ------------------------------------------------------------
    // INIT
    // ------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      // 0. Configure logging for this page
      Logging.setLevel("debug"); // show everything
      Logging.addSink(
        Logging.createDomSink("logBox", {
          maxEntries: 300,
          newestOnTop: false
        })
      );

      Logging.info("BrailleUI-Demo", "Pagina laden…");

      // 1. Sounds (optioneel)
      try {
        await Sounds.init("../config/sounds.json");
        Logging.info("Sounds", "Sounds.init OK");
      } catch (e) {
        Logging.error("Sounds", "Sounds.init fout: " + e);
      }

      // 2. BrailleBridge configureren
      BrailleBridge.setConfig({
        baseUrl: "http://localhost:5000",
        wsUrl: "ws://localhost:5000/ws",
        displayCells: 40,
        debug: true
      });

      // 3. BrailleUI configureren + monitor koppelen
      BrailleUI.setOptions({
        displayCells: 40,
        debug: true
      });
      BrailleUI.attachMonitor("brailleMonitor");

      // 4. Events van BrailleBridge
      BrailleBridge.on("connected", () => {
        setConnectionStatus("verbonden", true);
        Logging.info("BrailleBridge", "Connected");
      });

      BrailleBridge.on("disconnected", info => {
        setConnectionStatus("verbinding verbroken", false);
        Logging.warn("BrailleBridge", "Disconnected: " + (info.reason || ""));
      });

      BrailleBridge.on("error", err => {
        Logging.error("BrailleBridge", "Error: " + JSON.stringify(err));
      });

      // Optional: ruwe cursorrouting loggen
      BrailleBridge.on("cursor", evt => {
        Logging.debug("BrailleBridge", "[RAW cursor] " + JSON.stringify(evt));
      });

      // 5. Events van BrailleUI (letter + woord onder de cursor)

      // Letter onder de cursor
      BrailleUI.on("cursorChar", evt => {
        const letter = evt.char || "␣"; // spatie symbool
        const line   = evt.lineIndex;
        const col    = evt.column;

        setLastCursor(
          "Regel " + line +
          ", cel " + col +
          " → letter: \"" + letter + "\""
        );

        Logging.debug(
          "BrailleUI",
          "cursorChar line=" + line +
          " col=" + col +
          " letter=\"" + letter + "\""
        );
      });

      // Woord onder de cursor (als er een woord is)
      BrailleUI.on("cursorWord", evt => {
        const word   = evt.word || "(geen woord)";
        const line   = evt.lineIndex;
        const col    = evt.column;
        const letter = BrailleUI.getCharAt(col) || "␣";

        setLastCursor(
          "Regel " + line +
          ", cel " + col +
          " → letter: \"" + letter + "\", woord: \"" + word + "\""
        );

        Logging.info(
          "BrailleUI",
          "cursorWord line=" + line +
          " col=" + col +
          " letter=\"" + letter + "\" woord=\"" + word + "\""
        );

        // hier kun je eventueel geluid koppelen:
        // Sounds.playWord("nl", word);
      });

      // 6. Verbinden met BrailleBridge
      BrailleBridge.connect();

      // 7. Buttons aansluiten
      document.getElementById("btnHello").onclick = async () => {
        try {
          await BrailleUI.setText("Hallo braille!");
          Logging.info("BrailleUI", "setText('Hallo braille!') OK");
        } catch (e) {
          Logging.error("BrailleUI", "setText fout: " + e);
        }
      };

      document.getElementById("btnCustom").onclick = async () => {
        const text = document.getElementById("customText").value || "(leeg)";
        try {
          await BrailleUI.setText(text);
          Logging.info("BrailleUI", `setText(custom) OK: "${text}"`);
        } catch (e) {
          Logging.error("BrailleUI", "setText(custom) fout: " + e);
        }
      };

      document.getElementById("btnRepeat").onclick = async () => {
        try {
          await BrailleUI.repeatLine();
          Logging.info("BrailleUI", "repeatLine OK");
        } catch (e) {
          Logging.error("BrailleUI", "repeatLine fout: " + e);
        }
      };

      document.getElementById("btnClear").onclick = async () => {
        try {
          await BrailleUI.clear();
          Logging.info("BrailleUI", "clear OK");
        } catch (e) {
          Logging.error("BrailleUI", "clear fout: " + e);
        }
      };
    });
  </script>
</body>
</html>
