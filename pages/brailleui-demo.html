<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>BrailleUI Demo ‚Äì BrailleServer</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>

  <body class="demo-page demo-page--brailleui">
    <div class="demo-container">
      <h1>BrailleUI Demo</h1>
      <p class="demo-subtitle">
        Test de verbinding met de lokale BrailleBridge, bekijk de
        braille-monitor en simuleer duimtoetsen.
      </p>

      <!-- Verbinding -->
      <h2>Verbinding</h2>
      <div class="demo-row">
        <span id="connectionStatus" class="status-pill">
          <span class="status-dot"></span>
          disconnected
        </span>
        <button id="btnConnect" style="margin-left: 10px">
          Verbind met BrailleBridge
        </button>
      </div>

      <!-- Braille-monitor -->
      <h2>Braille-monitor (1:1 met leesregel)</h2>
      <div class="braille-monitor-label">
        Toon exact de 40 braillecellen (inclusief spaties).
      </div>
      <div id="currentLineBox" class="braille-monitor">(leeg)</div>

      <!-- Thumbkey-buttons -->
      <div class="thumbkey-buttons" aria-label="Simuleer duimtoetsen">
        <button type="button" data-thumb="LeftThumb">LeftThumb</button>
        <button type="button" data-thumb="MiddleLeftThumb">
          MiddleLeftThumb
        </button>
        <button type="button" data-thumb="MiddleRightThumb">
          MiddleRightThumb
        </button>
        <button type="button" data-thumb="RightThumb">RightThumb</button>
      </div>

      <!-- Regel sturen -->
      <h2>Regel sturen</h2>
      <div class="demo-row">
        <div class="demo-actions">
          <button id="btnHallo" class="primary" type="button">
            Stuur ‚ÄúHallo braille!‚Äù
          </button>
        </div>
      </div>

      <div class="demo-row">
        <label for="customTextInput">Eigen tekst:</label>
        <input
          type="text"
          id="customTextInput"
          placeholder="Typ een tekst om naar de brailleleesregel te sturen‚Ä¶"
        />
        <div class="demo-actions">
          <button id="btnSendCustom" type="button">Stuur eigen tekst</button>
          <button id="btnRepeat" type="button">Herhaal huidige regel</button>
          <button id="btnClear" type="button">Maak leeg</button>
        </div>
      </div>

      <!-- Cursorinformatie -->
      <h2>Laatste cursorinformatie</h2>
      <div id="cursorInfoBox">Nog niets‚Ä¶</div>

      <!-- Logging -->
      <h2>Logging</h2>
      <div id="logBox" class="log-box" aria-live="polite">
        <ul id="logList" class="log-list"></ul>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../js/braillebridge.js"></script>
    <script src="../js/brailleui.js"></script>

    <script>
      (function () {
        "use strict";

        const bridge = window.BrailleBridge;
        const ui = window.BrailleUI;

        // -----------------------------------------------------
        // Helpers
        // -----------------------------------------------------
        const connectionStatusEl = document.getElementById("connectionStatus");
        const btnConnect = document.getElementById("btnConnect");
        const logBox = document.getElementById("logBox");
        const logList = document.getElementById("logList");
        const cursorInfoBox = document.getElementById("cursorInfoBox");
        const customTextInput = document.getElementById("customTextInput");

        function setStatus(connected) {
          if (!connectionStatusEl) return;
          connectionStatusEl.classList.toggle("connected", !!connected);
          connectionStatusEl.textContent = connected
            ? "connected"
            : "disconnected";

          const dot = document.createElement("span");
          dot.className = "status-dot";
          connectionStatusEl.prepend(dot);
        }

        function logMessage(msg) {
          if (!logBox || !logList) return;
          const now = new Date();
          const ts = now.toISOString().split("T")[1].substring(0, 8);
          const li = document.createElement("li");
          li.textContent = "[" + ts + "] " + msg;
          if (logList.firstChild) {
            logList.insertBefore(li, logList.firstChild);
          } else {
            logList.appendChild(li);
          }

          while (logList.childElementCount > 200) {
            logList.removeChild(logList.lastElementChild);
          }

          logBox.scrollTop = 0;
        }

        // Simuleer een duimtoets door direct het 'thumbkey' event van
        // BrailleBridge te emitten. Dit is puur aan de JS-kant.
        function simulateThumbKey(name) {
          if (!bridge || typeof bridge.emit !== "function") {
            logMessage("‚ö†Ô∏è Kan thumbkey niet simuleren: geen bridge.emit()");
            return;
          }

          const evt = {
            raw: { Kind: 2, IsPress: true, Name: name },
            kindRaw: "thumbkey",
            kind: "thumbkey",
            press: true,
            name,
            nameLower: String(name).toLowerCase(),
          };

          logMessage("üñ±Ô∏è Simulated thumbkey: " + name);
          bridge.emit("thumbkey", evt);
        }

        // -----------------------------------------------------
        // BrailleBridge configureren
        // -----------------------------------------------------
        bridge.setConfig({
          debug: false,
          baseUrl: "http://localhost:5000",
          wsUrl: "ws://localhost:5000/ws",
          displayCells: 40,
        });

        // Logging van bridge
        bridge.on("connected", () => {
          setStatus(true);
          logMessage("‚úÖ WebSocket connected");
        });

        bridge.on("disconnected", (evt) => {
          setStatus(false);
          logMessage(
            "‚ùå WebSocket disconnected (code=" +
              evt.code +
              ", reason=" +
              evt.reason +
              ")"
          );
        });

        bridge.on("error", (err) => {
          logMessage("üí• Bridge error: " + JSON.stringify(err));
        });

        bridge.on("http", (evt) => {
          logMessage(
            "üåê HTTP " + evt.path + " ‚Üí " + evt.status + " (ok=" + evt.ok + ")"
          );
        });

        bridge.on("thumbkey", (evt) => {
          logMessage("üîµ thumbkey: " + evt.name);
        });

        bridge.on("cursor", (evt) => {
          // Dit pakt BrailleUI ook al op via autoAttachCursor,
          // maar we loggen hier nog extra informatie.
          logMessage("üéØ cursor index: " + evt.index);
        });

        // -----------------------------------------------------
        // BrailleUI koppelen
        // -----------------------------------------------------
        ui.setOptions({
          displayCells: 40,
          debug: false,
        });

        ui.attachMonitor("currentLineBox");

        // Cursor-info vanuit BrailleUI
        ui.on("cursorChar", (evt) => {
          const text =
            "Index: " +
            evt.index +
            "\n" +
            "Char:  " +
            (evt.char || " ") +
            "\n" +
            "Lijn:  " +
            evt.lineIndex;
          cursorInfoBox.textContent = text;
        });

        ui.on("cursorWord", (evt) => {
          logMessage(
            "üü¢ cursorWord: '" +
              evt.word +
              "' (start=" +
              evt.start +
              ", end=" +
              evt.end +
              ")"
          );
        });

        ui.on("lineChanged", (evt) => {
          logMessage("üîÅ lineChanged: '" + evt.line + "'");
        });

        // -----------------------------------------------------
        // UI events
        // -----------------------------------------------------
        btnConnect.addEventListener("click", () => {
          logMessage("üîå Connecting WebSocket...");
          bridge.connect();
        });

        document
          .getElementById("btnHallo")
          .addEventListener("click", async () => {
            try {
              await ui.setText("Hallo braille!");
              logMessage("‚û°Ô∏è Stuurde: 'Hallo braille!'");
            } catch (err) {
              logMessage("üí• Fout bij setText: " + err);
            }
          });

        document
          .getElementById("btnSendCustom")
          .addEventListener("click", async () => {
            const value = customTextInput.value || "";
            try {
              await ui.setText(value);
              logMessage("‚û°Ô∏è Stuurde eigen tekst: '" + value + "'");
            } catch (err) {
              logMessage("üí• Fout bij setText: " + err);
            }
          });

        document
          .getElementById("btnRepeat")
          .addEventListener("click", async () => {
            try {
              await ui.repeatLine();
              logMessage("üîÅ repeatLine()");
            } catch (err) {
              logMessage("üí• Fout bij repeatLine: " + err);
            }
          });

        document
          .getElementById("btnClear")
          .addEventListener("click", async () => {
            try {
              await ui.clear();
              logMessage("üßπ clear()");
            } catch (err) {
              logMessage("üí• Fout bij clear: " + err);
            }
          });

        // Thumbkey-buttons
        document
          .querySelectorAll(".thumbkey-buttons button")
          .forEach((btn) => {
            btn.addEventListener("click", () => {
              const name = btn.getAttribute("data-thumb");
              simulateThumbKey(name);
            });
          });

        // Option: automatisch verbinden bij laden
        // bridge.connect();
      })();
    </script>
  </body>
</html>
