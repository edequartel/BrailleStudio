<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>BrailleUI Demo – BrailleServer</title>

  <!-- Shared styling -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Optional: Howler (alleen nodig als je hier geluid gebruikt) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Core frameworks -->
  <script src="../js/logging.js"></script>
  <script src="../js/braillebridge.js"></script>
  <script src="../js/brailleui.js"></script>
  <script src="../js/sounds.js"></script>
  <!-- Reusable Braille monitor component -->
  <script src="../js/braillemonitor.js"></script>
</head>
<body>
  <main class="container">
    <h1>BrailleUI Demo</h1>

    <!-- Verbinding -->
    <section class="card">
      <h2>Verbinding</h2>
      <p>Status: <span id="connectionStatus">disconnected</span></p>
    </section>

    <!-- Reusable BRAILLEMONITOR component -->
    <section class="card">
      <h2>Braille-monitor</h2>
      <div id="brailleMonitorComponent"></div>
    </section>

    <!-- Acties voor de demo -->
    <section class="card">
      <h2>Regel sturen</h2>

      <div class="button-row">
        <button id="btnHello">Stuur “Hallo braille!”</button>
      </div>

      <label for="customText">Eigen tekst:</label><br />
      <input id="customText"
             type="text"
             placeholder="Typ hier je tekst"
             style="width: 100%; max-width: 420px; margin-top: 4px;" /><br /><br />

      <div class="button-row">
        <button id="btnCustom">Stuur eigen tekst</button>
        <button id="btnRepeat">Herhaal huidige regel</button>
        <button id="btnClear">Maak leeg</button>
      </div>
    </section>

    <!-- Cursor info -->
    <section class="card">
      <h2>Laatste cursorinformatie</h2>
      <p id="lastCursor">Nog niets…</p>
    </section>

    <!-- Logging -->
    <section class="card">
      <h2>Logging</h2>
      <div id="logBox" class="log-box"></div>
    </section>
  </main>

  <script>
    function setConnectionStatus(text, ok) {
      const el = document.getElementById("connectionStatus");
      if (!el) return;
      el.textContent = text;
      el.style.color = ok ? "green" : "red";
    }

    function setLastCursor(text) {
      const el = document.getElementById("lastCursor");
      if (el) el.textContent = text;
    }

    /**
     * Shared handler voor "cursor routing" – zowel echte cursorrouting
     * als klikken op de cellen in de braillemonitor.
     *
     * info = { index, letter, word }
     */
    function handleCursorEvent(info) {
      const { index, letter, word } = info;
      const safeLetter = letter || "␣";
      const safeWord = word && word.trim() ? word : "(geen woord)";

      setLastCursor(
        "Cel " +
          index +
          ' → letter: "' +
          safeLetter +
          '", woord: "' +
          safeWord +
          '"'
      );

      Logging.info(
        "Cursor",
        "index=" +
          index +
          ' letter="' +
          safeLetter +
          '" woord="' +
          safeWord +
          '"'
      );
    }

    // ------------------------------------------------------------
    // INIT
    // ------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      // 0. Logging voor deze pagina
      Logging.setLevel("debug");
      Logging.addSink(
        Logging.createDomSink("logBox", {
          maxEntries: 300,
          newestOnTop: false
        })
      );
      Logging.info("BrailleUI-Demo", "Pagina laden…");

      // 1. Sounds (optioneel)
      try {
        await Sounds.init("../config/sounds.json");
        Logging.info("Sounds", "Sounds.init OK");
      } catch (e) {
        Logging.error("Sounds", "Sounds.init fout: " + e);
      }

      // 2. BrailleBridge configureren
      BrailleBridge.setConfig({
        baseUrl: "http://localhost:5000",
        wsUrl: "ws://localhost:5000/ws",
        displayCells: 40,
        debug: true
      });

      // 3. BrailleUI configureren
      BrailleUI.setOptions({
        displayCells: 40,
        debug: true
      });

      // 4. Reusable Braille-monitor component initialiseren
      const monitor = BrailleMonitor.init({
        containerId: "brailleMonitorComponent",

        // Duimtoets-mapping: hier koppel je iedere thumbkey aan een actie
        mapping: {
          leftthumb: () => document.getElementById("btnHello").click(),
          middleleftthumb: () => document.getElementById("btnCustom").click(),
          middlerightthumb: () => document.getElementById("btnRepeat").click(),
          rightthumb: () => document.getElementById("btnClear").click()
        },

        // Klik op een cel in de monitor = zelfde als cursorrouting
        onCursorClick(info) {
          handleCursorEvent(info);
        }
      });

      // 4b. AUTOMATISCHE SYNC: zorg dat elke BrailleUI.setText / clear
      //     altijd ook de monitor bijwerkt.
      if (monitor && typeof monitor.setText === "function") {
        if (typeof BrailleUI.setText === "function") {
          const originalSetText = BrailleUI.setText.bind(BrailleUI);
          BrailleUI.setText = async function (text) {
            const result = await originalSetText(text);
            monitor.setText(text != null ? String(text) : "");
            Logging.debug(
              "BrailleUI-Demo",
              "Monitor sync na setText: \"" + (text || "") + "\""
            );
            return result;
          };
        }

        if (typeof BrailleUI.clear === "function") {
          const originalClear = BrailleUI.clear.bind(BrailleUI);
          BrailleUI.clear = async function () {
            const result = await originalClear();
            monitor.clear();
            Logging.debug("BrailleUI-Demo", "Monitor sync na clear");
            return result;
          };
        }
      }

      // 5. BrailleBridge events
      BrailleBridge.on("connected", () => {
        setConnectionStatus("verbonden", true);
        Logging.info("BrailleBridge", "Connected");
      });

      BrailleBridge.on("disconnected", (info) => {
        setConnectionStatus("verbinding verbroken", false);
        Logging.warn(
          "BrailleBridge",
          "Disconnected: " + (info && info.reason ? info.reason : "")
        );
      });

      BrailleBridge.on("error", (err) => {
        Logging.error("BrailleBridge", "Error: " + JSON.stringify(err));
      });

      // Optioneel: ruwe cursorrouting loggen
      BrailleBridge.on("cursor", (evt) => {
        Logging.debug("BrailleBridge", "[RAW cursor] " + JSON.stringify(evt));
      });

      // 6. BrailleUI cursor events – roepen dezelfde handler aan
      BrailleUI.on("cursorWord", (evt) => {
        const index =
          typeof evt.column === "number" ? evt.column : (evt.index || 0);

        const letter =
          typeof BrailleUI.getCharAt === "function"
            ? BrailleUI.getCharAt(index)
            : (evt.char || " ");

        const word = evt.word || "";

        handleCursorEvent({ index, letter, word });
      });

      // 7. Verbinden met BrailleBridge
      BrailleBridge.connect();

      // 8. Knoppen aansluiten – nu alleen BrailleUI.setText/clear,
      //    de monitor wordt automatisch gesynchroniseerd via de wrapper.
      document.getElementById("btnHello").onclick = async () => {
        const text = "Hallo braille!";
        try {
          await BrailleUI.setText(text);
          Logging.info("BrailleUI", "setText('Hallo braille!') OK");
        } catch (e) {
          Logging.error("BrailleUI", "setText fout: " + e);
        }
      };

      document.getElementById("btnCustom").onclick = async () => {
        const text = document.getElementById("customText").value || "(leeg)";
        try {
          await BrailleUI.setText(text);
          Logging.info("BrailleUI", `setText(custom) OK: "${text}"`);
        } catch (e) {
          Logging.error("BrailleUI", "setText(custom) fout: " + e);
        }
      };

      document.getElementById("btnRepeat").onclick = async () => {
        try {
          await BrailleUI.repeatLine();
          // Tekst blijft hetzelfde; monitor is al in sync
          Logging.info("BrailleUI", "repeatLine OK");
        } catch (e) {
          Logging.error("BrailleUI", "repeatLine fout: " + e);
        }
      };

      document.getElementById("btnClear").onclick = async () => {
        try {
          await BrailleUI.clear();
          Logging.info("BrailleUI", "clear OK");
        } catch (e) {
          Logging.error("BrailleUI", "clear fout: " + e);
        }
      };
    });
  </script>
</body>
</html>
