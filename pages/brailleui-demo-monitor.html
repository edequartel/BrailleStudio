<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>BrailleUI Demo – BrailleServer</title>

  <!-- Shared styling -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Optional: Howler (only if you want sounds hier) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Core frameworks -->
  <script src="../js/logging.js"></script>
  <script src="../js/braillebridge.js"></script>
  <script src="../js/brailleui.js"></script>
  <script src="../js/sounds.js"></script>
  <!-- NEW: reusable Braille monitor component -->
  <script src="../js/braillemonitor.js"></script>
</head>
<body>
  <main class="container">
    <h1>BrailleUI Demo</h1>

    <!-- Verbinding -->
    <section class="card">
      <h2>Verbinding</h2>
      <p>Status: <span id="connectionStatus">disconnected</span></p>
    </section>

    <!-- Reusable BRAILLEMONITOR component -->
    <section class="card">
      <h2>Braille-monitor</h2>
      <div id="brailleMonitorComponent"></div>
    </section>

    <!-- Acties voor de demo -->
    <section class="card">
      <h2>Regel sturen</h2>
      <div class="button-row">
        <button id="btnHello">Stuur “Hallo braille!”</button>
      </div>

      <label for="customText">Eigen tekst:</label><br />
      <input id="customText" type="text"
             placeholder="Typ hier je tekst"
             style="width: 100%; max-width: 420px; margin-top: 4px;" /><br /><br />

      <div class="button-row">
        <button id="btnCustom">Stuur eigen tekst</button>
        <button id="btnRepeat">Herhaal huidige regel</button>
        <button id="btnClear">Maak leeg</button>
      </div>
    </section>

    <!-- Cursor info -->
    <section class="card">
      <h2>Laatste cursorinformatie</h2>
      <p id="lastCursor">Nog niets…</p>
    </section>

    <!-- Logging -->
    <section class="card">
      <h2>Logging</h2>
      <div id="logBox" class="log-box"></div>
    </section>
  </main>

  <script>
    function setConnectionStatus(text, ok) {
      const el = document.getElementById("connectionStatus");
      if (!el) return;
      el.textContent = text;
      el.style.color = ok ? "green" : "red";
    }

    function setLastCursor(text) {
      const el = document.getElementById("lastCursor");
      if (el) el.textContent = text;
    }

    // ------------------------------------------------------------
    // INIT
    // ------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      // 0. Logging voor deze pagina
      Logging.setLevel("debug");
      Logging.addSink(
        Logging.createDomSink("logBox", {
          maxEntries: 300,
          newestOnTop: false
        })
      );
      Logging.info("BrailleUI-Demo", "Pagina laden…");

      // 1. Sounds (optioneel)
      try {
        await Sounds.init("../config/sounds.json");
        Logging.info("Sounds", "Sounds.init OK");
      } catch (e) {
        Logging.error("Sounds", "Sounds.init fout: " + e);
      }

      // 2. BrailleBridge configureren
      BrailleBridge.setConfig({
        baseUrl: "http://localhost:5000",
        wsUrl: "ws://localhost:5000/ws",
        displayCells: 40,
        debug: true
      });

      // 3. BrailleUI configureren
      BrailleUI.setOptions({
        displayCells: 40,
        debug: true
      });

      // 4. Braille-monitor component initialiseren
      BrailleMonitor.init({
        containerId: "brailleMonitorComponent",
        mapping: {
          leftthumb: () => document.getElementById("btnHello").click(),
          middleleftthumb: () => document.getElementById("btnCustom").click(),
          middlerightthumb: () => document.getElementById("btnRepeat").click(),
          rightthumb: () => document.getElementById("btnClear").click()
        }
      });

      // 5. BrailleBridge events
      BrailleBridge.on("connected", () => {
        setConnectionStatus("verbonden", true);
        Logging.info("BrailleBridge", "Connected");
      });

      BrailleBridge.on("disconnected", (info) => {
        setConnectionStatus("verbinding verbroken", false);
        Logging.warn(
          "BrailleBridge",
          "Disconnected: " + (info && info.reason ? info.reason : "")
        );
      });

      BrailleBridge.on("error", (err) => {
        Logging.error("BrailleBridge", "Error: " + JSON.stringify(err));
      });

      // Ruwe cursor log (optioneel)
      BrailleBridge.on("cursor", (evt) => {
        Logging.debug("BrailleBridge", "[RAW cursor] " + JSON.stringify(evt));
      });

      // 6. BrailleUI cursor events
      BrailleUI.on("cursorChar", (evt) => {
        const letter = evt.char || "␣";
        const line = evt.lineIndex;
        const col = evt.column;

        setLastCursor(
          "Regel " + line + ", cel " + col + " → letter: \"" + letter + "\""
        );

        Logging.debug(
          "BrailleUI",
          "cursorChar line=" +
            line +
            " col=" +
            col +
            ' letter="' +
            letter +
            '"'
        );
      });

      BrailleUI.on("cursorWord", (evt) => {
        const word = evt.word || "(geen woord)";
        const line = evt.lineIndex;
        const col = evt.column;
        const letter = BrailleUI.getCharAt(col) || "␣";

        setLastCursor(
          "Regel " +
            line +
            ", cel " +
            col +
            ' → letter: "' +
            letter +
            '", woord: "' +
            word +
            '"'
        );

        Logging.info(
          "BrailleUI",
          "cursorWord line=" +
            line +
            " col=" +
            col +
            ' letter="' +
            letter +
            '" woord="' +
            word +
            '"'
        );
      });

      // 7. Verbinden met BrailleBridge
      BrailleBridge.connect();

      // 8. Knoppen aansluiten
      document.getElementById("btnHello").onclick = async () => {
        try {
          await BrailleUI.setText("Hallo braille!");
          Logging.info("BrailleUI", "setText('Hallo braille!') OK");
        } catch (e) {
          Logging.error("BrailleUI", "setText fout: " + e);
        }
      };

      document.getElementById("btnCustom").onclick = async () => {
        const text = document.getElementById("customText").value || "(leeg)";
        try {
          await BrailleUI.setText(text);
          Logging.info("BrailleUI", `setText(custom) OK: "${text}"`);
        } catch (e) {
          Logging.error("BrailleUI", "setText(custom) fout: " + e);
        }
      };

      document.getElementById("btnRepeat").onclick = async () => {
        try {
          await BrailleUI.repeatLine();
          Logging.info("BrailleUI", "repeatLine OK");
        } catch (e) {
          Logging.error("BrailleUI", "repeatLine fout: " + e);
        }
      };

      document.getElementById("btnClear").onclick = async () => {
        try {
          await BrailleUI.clear();
          Logging.info("BrailleUI", "clear OK");
        } catch (e) {
          Logging.error("BrailleUI", "clear fout: " + e);
        }
      };
    });
  </script>
</body>
</html>
