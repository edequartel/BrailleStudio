<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Braille Game – Komt het dier overeen?</title>

  <link rel="stylesheet" href="../css/style.css" />

  <!-- Howler -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Frameworks -->
  <script src="../js/logging.js"></script>
  <script src="../js/braillebridge.js"></script>
  <script src="../js/brailleui.js"></script>
  <script src="../js/sounds.js"></script>
</head>

<body class="game-page game-page--dier-match">
<div class="container">

  <h1>Braille Game – Komt het dier overeen?</h1>

  <p>
    Je hoort een dier (kat, paard, koe, hond, vogel).<br>
    Op de brailleleesregel staat óók een diernaam.<br>
    <strong>Vraag:</strong> Is het <em>dezelfde</em> diernaam als die je hoort?
  </p>

  <ul>
    <li><strong>LeftThumb</strong> → <strong>NIET</strong> hetzelfde dier.</li>
    <li><strong>RightThumb</strong> → <strong>WEL</strong> hetzelfde dier.</li>
  </ul>

  <div id="connectionStatus">WebSocket: nog niet verbonden…</div>

  <h2>Bediening</h2>
  <div class="button-row">
    <button id="btnStartRound">Nieuwe ronde</button>
    <button id="btnRepeatWord">Herhaal woord</button>
    <button id="btnRepeatLine">Herhaal braille</button>
    <button id="btnClear">Maak braille leeg</button>
    <button id="btnToggleLog">Toon log</button>
  </div>

  <h2>Ronde</h2>
  <div class="status" id="roundInfo">Nog geen ronde gestart.</div>

  <h2>Woord op brailleleesregel</h2>
  <div class="braille-monitor-label">
    Volledige 40 braillecellen (inclusief spaties).
  </div>
  <div class="braille-monitor" id="currentLineBox">(leeg)</div>

  <h2>Laatste antwoord</h2>
  <div class="status" id="lastAnswerBox">Nog geen antwoord.</div>

  <h2>Thumbkey-simulator</h2>
  <p class="small">
    Test de duimtoetsen zonder je leesregel: klik op een knop om hetzelfde effect als de hardware te simuleren.
  </p>
  <div class="thumbkey-buttons" aria-label="Simuleer duimtoetsen">
    <button type="button" data-thumb="LeftThumb">LeftThumb (NIET hetzelfde)</button>
    <button type="button" data-thumb="RightThumb">RightThumb (WEL hetzelfde)</button>
  </div>

  <div id="logContainer" hidden>
    <h2>Log</h2>
    <div id="logBox" class="log-box" aria-live="polite"></div>
  </div>

</div>

<script>
  const MAX_CELLS = 40;
  const NEXT_ROUND_DELAY = 3000; // ms
  const WORDS = ["kat", "paard", "koe", "hond", "vogel"];

  let currentAudioWord = null;  // woord dat je hoort
  let currentBrailleWord = null; // woord dat op de regel staat
  let isMatch = null;           // true als gelijk, false als verschillend
  let logVisible = false;

  const ui = window.BrailleUI || null;

  function pageLog(message, level = "info", source = "Game") {
    if (!window.Logging) {
      console.log(`[${source}] ${message}`);
      return;
    }

    const lvl = String(level).toLowerCase();
    switch (lvl) {
      case "debug":
        Logging.debug(source, message);
        break;
      case "warn":
        Logging.warn(source, message);
        break;
      case "error":
        Logging.error(source, message);
        break;
      default:
        Logging.info(source, message);
        break;
    }
  }

  function toggleLog() {
    logVisible = !logVisible;
    const container = document.getElementById("logContainer");
    const btn = document.getElementById("btnToggleLog");
    if (container) {
      container.hidden = !logVisible;
    }
    btn.textContent = logVisible ? "Verberg log" : "Toon log";
  }

  function setConnectionStatus(text, ok) {
    const el = document.getElementById("connectionStatus");
    el.textContent = "WebSocket: " + text;
    el.dataset.state = ok ? "connected" : "disconnected";
  }

  function setRoundInfo(text) {
    document.getElementById("roundInfo").textContent = text;
  }

  function setLastAnswer(text) {
    document.getElementById("lastAnswerBox").textContent = text;
  }

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  async function startNewRound() {
    currentAudioWord = randomFrom(WORDS);

    if (Math.random() < 0.5) {
      currentBrailleWord = currentAudioWord;
      isMatch = true;
    } else {
      const others = WORDS.filter(w => w !== currentAudioWord);
      currentBrailleWord = randomFrom(others);
      isMatch = false;
    }

    const padded = currentBrailleWord.padEnd(MAX_CELLS, " ").substring(0, MAX_CELLS);

    setRoundInfo(
      `Nieuwe ronde: hoor je hetzelfde dier als op de braille-regel? (audio: ?)`
    );
    setLastAnswer("Nog geen antwoord.");

    pageLog(
      `Nieuwe ronde: audioWord="${currentAudioWord}", brailleWord="${currentBrailleWord}", match=${isMatch}`
    );

    // speel het woord
    Sounds.playWord("nl", currentAudioWord);

    // stuur naar brailleleesregel via BrailleUI
    try {
      await ui.setText(padded);
      pageLog("Braille-regel verzonden via BrailleUI", "debug", "BrailleUI");
    } catch (e) {
      pageLog("setText error: " + e, "error", "BrailleUI");
    }
  }

  function repeatWord() {
    if (!currentAudioWord) return;
    Sounds.playWord("nl", currentAudioWord);
    pageLog("Woord opnieuw afgespeeld: " + currentAudioWord);
  }

  async function repeatLine() {
    if (!currentBrailleWord) return;
    try {
      await ui.repeatLine();
      pageLog("Braille-regel opnieuw verzonden: " + currentBrailleWord);
    } catch (err) {
      pageLog("repeatLine error: " + err, "error", "BrailleUI");
    }
  }

  function handleUserAnswer(userSaysMatch, src) {
    if (!currentAudioWord || !currentBrailleWord) return;

    const correct = (userSaysMatch === isMatch);
    const word = userSaysMatch ? "JA (zelfde)" : "NEE (anders)";

    pageLog(`${src}: ${word} → correct=${correct}`);

    if (correct) {
      setLastAnswer(`Goed! ${word} is juist.`);
      Sounds.playUI("nl", "correct");
    } else {
      setLastAnswer(`Fout! ${word} is niet juist.`);
      Sounds.playUI("nl", "mistake");
    }

    setTimeout(startNewRound, NEXT_ROUND_DELAY);
  }

  function handleThumbKey(name) {
    pageLog("Thumbkey: " + name, "debug", "BrailleBridge");

    const n = name.toLowerCase();
    if (n === "leftthumb") {
      handleUserAnswer(false, "LeftThumb");
    } else if (n === "rightthumb" || n === "rightthumbkey") {
      handleUserAnswer(true, "RightThumb");
    }
  }

  function simulateThumbKey(name) {
    pageLog("Simulated thumbkey via UI: " + name, "info", "UI");
    handleThumbKey(name);
  }

  window.addEventListener("DOMContentLoaded", async () => {
    if (window.Logging) {
      Logging.setLevel("debug");
      Logging.addSink(
        Logging.createDomSink("logBox", {
          maxEntries: 400,
          newestOnTop: false
        })
      );
    }

    if (ui) {
      ui.setOptions({
        displayCells: MAX_CELLS,
        debug: false
      });
      ui.attachMonitor("currentLineBox");
      ui.on("lineChanged", (evt) => {
        pageLog(`BrailleUI lineChanged: '${evt.line}'`, "debug", "BrailleUI");
      });
    } else {
      pageLog("BrailleUI niet beschikbaar, monitor werkt niet.", "error", "BrailleUI");
    }

    // Sounds
    await Sounds.init("../config/sounds.json", (msg) => pageLog(msg, "info", "Sounds"));

    // BrailleBridge configureren
    BrailleBridge.setConfig({
      baseUrl: "http://localhost:5000",
      wsUrl: "ws://localhost:5000/ws",
      displayCells: MAX_CELLS,
      debug: true
    });

    BrailleBridge.on("connected", () => {
      setConnectionStatus("verbonden", true);
      pageLog("WebSocket connected", "info", "BrailleBridge");
    });
    BrailleBridge.on("disconnected", () => {
      setConnectionStatus("verbroken", false);
      pageLog("WebSocket disconnected", "warn", "BrailleBridge");
    });
    BrailleBridge.on("thumbkey", (evt) => handleThumbKey(evt.nameLower));
    BrailleBridge.on("cursor", (evt) =>
      pageLog("Cursor index=" + evt.index, "debug", "BrailleBridge")
    );
    BrailleBridge.on("error", (err) =>
      pageLog("Bridge error: " + err.error, "error", "BrailleBridge")
    );

    BrailleBridge.connect();

    document.getElementById("btnStartRound").onclick = startNewRound;
    document.getElementById("btnRepeatWord").onclick = repeatWord;
    document.getElementById("btnRepeatLine").onclick = repeatLine;
    document.getElementById("btnClear").onclick = async () => {
      try {
        await ui.clear();
        pageLog("Display leeggemaakt", "info", "BrailleUI");
      } catch (err) {
        pageLog("Clear error: " + err, "error", "BrailleUI");
      }
    };
    document.getElementById("btnToggleLog").onclick = toggleLog;
    document.querySelectorAll(".thumbkey-buttons button").forEach((btn) => {
      btn.addEventListener("click", () => {
        const thumb = btn.getAttribute("data-thumb");
        if (thumb) {
          simulateThumbKey(thumb);
        }
      });
    });

    // optioneel eerste ronde pas na enige actie;
    // maar als autoplay ok is, kun je deze direct laten starten:
    // startNewRound();
  });
</script>

</body>
</html>
